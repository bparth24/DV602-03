<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Assignment 3</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.15/d3.min.js" charset="utf-8" type="text/javascript"></script>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            #name{ color: blue;}
            .makebold{ font-weight: bold;}
            .makeItalic{ font-style: italic;font-weight: normal;}
            .inner{fill: #ccc; stroke: #000;}
            .outer{fill: none; stroke: #000;}
            .outer,.inner{shape-rendering: crispEdges;}
            .axis {fill: none; stroke: #000;shape-rendering: crispEdges;}
            body{font:10px sans-serif;}

            path.state-boundary {
                stroke: #000;
                stroke-width: .5px;
            }

            /* generated by http://colorbrewer2.org */

            .q0-7{fill:rgb(255,255,212)} 
            .q1-7{fill:rgb(254,227,145)} 
            .q2-7{fill:rgb(254,196,79)} 
            .q3-7{fill:rgb(254,153,41)} 
            .q4-7{fill:rgb(236,112,20)} 
            .q5-7{fill:rgb(204,76,2)} 
            .q6-7{fill:rgb(140,45,4)}
            
            rect.bordered {
                stroke: #E6E6E6;
                stroke-width:2px;   
            }

            text.mono {
                font-size: 9pt;
                font-family: Consolas, courier;
                fill: #aaa;
            }

            text.axis-workweek {
                fill: #000;
            }

            text.axis-worktime {
                fill: #000;
            }

        </style>
    </head>
    <body>
        <div style="margin-left: 20px; margin-right: 20px">
            <!-- Information Section starts -->
            <div id="Info">
                <h3 id="name">Parth K. Bhatt</h3>
                <h4 id="studentID" class="makebold">#007</h4>
                <h4 id="courseTitle" class="makebold">Data Visualization (DSC 530/602-01)</h4>
                <h4 id="assignmentTitle" class="makeItalic">Assignment #3</h4>
                <p>This assignment is all my own work. I did not copy or rewrite the code from any other source.</p>
            </div>
            <!-- Information Section ends -->

            <!-- Candidate visits Choropleth starts-->
            <hr>
            <h1 class="makebold">Choropleth Map</h1>
            <div id="Choropleth"></div>
            <!-- Top 10 Stops starts-->
            <hr>
            <h1 class="makebold">Top 10 Stops</h1>
            <div id="Top10stops"></div>
            <!-- City-Similarity starts-->
            <hr>
            <h1 class="makebold">City Similarity</h1>
            <div id="CitySimilarity"></div>
            <!-- Extra Credits Candidate Visits Heatmap starts-->
            <hr>
            <h1 class="makebold">Candidate Visits Heatmap</h1>
            <div id="Heatmap"></div>
            <!-- References starts-->
            <hr>
            <h1 class="makebold">References</h1>
            <div id="References">
                <a href="http://colorbrewer2.org"> For Color Code Generating</a><br>
                <a href="http://bl.ocks.org/phoebebright/raw/3176159/">D3 Nest examples</a><br>
                <a href="https://github.com/d3/d3-queue">Queue concept</a><br>
                <a href="http://bl.ocks.org/tjdecke/5558084">Heatmap example</a>
            </div>
        </div>
        <script src="https://d3js.org/d3-queue.v2.min.js" type="text/javascript"></script>
        <script>
            function createMap(divId, data_f1, data_f2) {
                // code for f1data file
                var w = 960;
                var h = 600;

                //Create an SVG element.
                var mapSVG = d3.select(divId)
                        .append("svg")
                        .attr("width", w)
                        .attr("height", h);

                var projection = d3.geo.albersUsa()
                        .scale([1000])
                        .translate([w / 2, h / 2]);

                var path = d3.geo.path()
                        .projection(projection);

                var count_values = d3.map();
                var temp = 0;
                //console.log(data_f1.features);
                for (var i = 0; i < data_f1.features.length; i++) {
                    temp = 0;
                    for (var j = 0; j < data_f2.results.length; j++) {
                        if (data_f1.features[i].properties.abbrv === data_f2.results[j].state) {
                            temp++;
                        }
                    }
                    count_values.set(data_f1.features[i].properties.abbrv, temp);
                }
                console.log(count_values);
                var colExtent = d3.extent(count_values.values());
                var color = d3.scale.quantize()
                        .domain(colExtent)
                        .range(d3.range(7).map(function (i) {
                            return "q" + i + "-7";
                        }));

                mapSVG.append("g").selectAll("path")
                        .data(data_f1.features)
                        .enter()
                        .append("path")
                        .attr("d", path)
                        .attr("class", function (d) {
                            return "state-boundary " + color(count_values.get(d.properties.abbrv));
                        });

                // create legend
                var legendSize = 210;
                var numLevels = 7;

                var legend = mapSVG.append("g");
                var levels = legend.selectAll("levels")
                        .data(d3.range(numLevels))
                        .enter()
                        .append("rect")
                        .attr("x", function (d) {
                            return w - legendSize - 20 + d * legendSize / numLevels;
                        })
                        .attr("y", h - 60)
                        .attr("width", legendSize / numLevels)
                        .attr("height", 16)
                        .style("stroke", "none")
                        .attr("class", function (d) {
                            return "q" + d + "-" + numLevels;
                        });

                legend.append("text")
                        .attr("x", w - legendSize - 20)
                        .attr("y", h - 24)
                        .attr("text-anchor", "middle")
                        .text(colExtent[0]);

                legend.append("text")
                        .attr("x", w - 20)
                        .attr("y", h - 24)
                        .attr("text-anchor", "middle")
                        .text(colExtent[1]);

                legend.append("text")
                        .attr("x", w - legendSize / 2 - 20)
                        .attr("y", h - 24)
                        .attr("text-anchor", "middle")
                        .text("Number of Trips");
            }

            // part3
            function createTopTenStopsMap(divId, data_f1, data_f2, data_f3) {
                var w = 960;
                var h = 600;

                //Create an SVG element.
                var mapSVG = d3.select(divId)
                        .append("svg")
                        .attr("width", w)
                        .attr("height", h)
                        .style("fill", "none");

                var projection = d3.geo.albersUsa()
                        .scale([1000])
                        .translate([w / 2, h / 2]);

                var path = d3.geo.path()
                        .projection(projection);

                mapSVG.append("g").selectAll("path")
                        .data(data_f1.features)
                        .enter()
                        .append("path")
                        .attr("d", path)
                        .attr("class", "state-boundary");

                var stops_data = [];

                for (var i = 0; i < data_f2.results.length; i++) {
                    if (data_f2.results[i].stops.length >= 1) {
                        for (var j = 0; j < data_f2.results[i].stops.length; j++) {
                            stops_data.push({"placeid": data_f2.results[i].stops[j].placeid, "city": data_f2.results[i].stops[j].city, "state": data_f2.results[i].stops[j].state, "lat": data_f2.results[i].stops[j].lat, "lng": data_f2.results[i].stops[j].lng});
                        }
                    }
                }
                //console.log(stops_data);

                //Reference: http://bl.ocks.org/phoebebright/raw/3176159/
                var alldata = d3.nest().key(function (d) {
                    return d.placeid;
                }).entries(stops_data);
                // console.log(alldata);

                var placeidaskey = d3.nest().key(function (d) {
                    return d.placeid;
                }).rollup(function (v) {
                    return v.length;
                }).entries(stops_data);
                // console.log(JSON.stringify(placeidaskey));

                //  References: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/sort
                placeidaskey.sort(function (a, b) {
                    if (a.values < b.values) {
                        return 1;
                    }
                    if (a.values > b.values) {
                        return -1;
                    }
                    // a must be equal to b
                    return 0;
                });
                //console.log(placeidaskey);
                var mostvisited = placeidaskey.slice(0, 10);
                // console.log(mostvisited);

                var toptenarr = [];
                for (var i = 0; i < mostvisited.length; i++) {
                    for (var j = 0; j < alldata.length; j++) {
                        if (mostvisited[i].key === alldata[j].key) {
                            toptenarr.push({"city": alldata[j].values[0].city, "state": alldata[j].values[0].state, "lat": alldata[j].values[0].lat, "lng": alldata[j].values[0].lng});
                        }
                    }
                }
                //console.log(toptenarr);

                mapSVG.append("g").selectAll("circle")
                        .data(toptenarr)
                        .enter().append("circle")
                        .attr("cx", function (d) {
                            return projection([d.lng, d.lat])[0];
                        })
                        .attr("cy", function (d) {
                            return projection([d.lng, d.lat])[1];
                        })
                        .attr("r", 2.8)
                        .style("fill", "blue");

                mapSVG.append("g").selectAll("text")
                        .data(toptenarr)
                        .enter().append("text")
                        .attr("x", function (d) {
                            return projection([d.lng, d.lat])[0];
                        })
                        .attr("y", function (d) {
                            return projection([d.lng, d.lat])[1];
                        })
                        .attr("text-anchor", "middle")
                        .attr("font-size", "10pt")
                        .style("fill", "red")
                        .text(function (d) {
                            return d.city;
                        });
                createCitySimilarityMap("#CitySimilarity", data_f3, toptenarr);
            }

            //part3
            function createCitySimilarityMap(divId, data_f3, topten) {

                var data_nodes = topten;
                //console.log(data_nodes);

                data_nodes.sort(function (a, b) {
                    if (a.city < b.city)
                        return -1;
                    if (a.city > b.city)
                        return 1;
                    return 0;
                });
                //console.log(data_nodes);

                function commaformat(str1, str2) {
                    var result = str1 + ", " + str2;
                    return result;
                }

                function k_combinations(set, k) {
                    var i, j, combs, head;

                    combs = [];
                    for (i = 0; i < set.length; i++) {
                        // head is a list that includes only our current element.
                        head = set.slice(i, i + 1);
                        //console.log(head);

                        var temphead = head[0];
                        //console.log(temphead);

                        var tail = set.slice(i + 1);

                        for (j = 0; j < tail.length; j++) {
                            var tempvalue = data_f3[commaformat(head[0].city, head[0].state) + ":" + commaformat(tail[j].city, tail[j].state)];
                            combs.push({"source": head[0], "target": tail[j], "value": tempvalue});
                        }
                    }
                    //console.log(combs);
                    return combs;
                }

                var all_combs = k_combinations(data_nodes, 2);
                //console.log(all_combs);

                var w = 900;
                var h = 600;

                var force = d3.layout.force()
                        .nodes(data_nodes)
                        .links(all_combs)
                        .size([w, h])
                        .linkDistance([450])
                        .linkStrength(function (d) {
                            return d.value;
                        })
                        .charge([-450])
                        .start();

                var color = d3.scale.category10();

                // Create SVG element.
                var mySVG = d3.select(divId)
                        .append("svg")
                        .attr("width", w)
                        .attr("height", h);

                // Create edges as lines.
                var edges = mySVG.selectAll("line")
                        .data(all_combs)
                        .enter()
                        .append("line")
                        .style("fill", "none")
                        .style("stroke", "#ccc")
                        .style("stroke-width", "2px");

                // Create nodes as circles.
                var nodes = mySVG.selectAll("circle")
                        .data(data_nodes)
                        .enter()
                        .append("circle")
                        .attr("r", 10)
                        .style("fill", function (d, i) {
                            return color(i);
                        })
                        .call(force.drag);

                force.on("tick", function () {
                    var x = function (d) {
                        return d.x;
                    };
                    var y = function (d) {
                        return d.y;
                    };

                    edges.attr("x1", function (d) {
                        return d.source.x;
                    })
                            .attr("y1", function (d) {
                                return d.source.y;
                            })
                            .attr("x2", function (d) {
                                return d.target.x;
                            })
                            .attr("y2", function (d) {
                                return d.target.y;
                            });

                    nodes.attr("cx", x).attr("cy", y);

                    label.attr("dx", x)
                            .attr("dy", y)
                            .attr("transform", function (d) {
                                return "translate(" + (+10) + "," + (+5) + ")";
                            });
                });

                var label = mySVG.selectAll("text")
                        .data(data_nodes)
                        .enter()
                        .append("text")
                        .text(function (d) {
                            return d.city;
                        })
                        .style("fill", "#555")
                        .style("font-family", "Arial")
                        .style("font-size", 12);
            }
            //part4
            function candidateVisitsHeatmap(divId, data_f2) {

                // Reference http://bl.ocks.org/tjdecke/5558084
                var margin = {top: 50, right: 0, bottom: 100, left: 130};
                var w = 960 - margin.left - margin.right;
                var h = 920 - margin.top - margin.botom;
                var gridSize = Math.floor(w / 24);
                var legendElementWidth = gridSize * 2;
                var buckets = 9;
                var states = ["SC", "IA", "NH"];

                var candidate_name = data_f2.params.candidates.split(',', 25);
                console.log(candidate_name);

                var colors = data_f2.params.colors.split(',', 9);
                //console.log(colors);

                var svg = d3.select("#Heatmap").append("svg")
                        .attr("width", 960)
                        .attr("height", 920)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var nameLabels = svg.selectAll(".nameLabels")
                        .data(candidate_name)
                        .enter()
                        .append("text")
                        .text(function (d) {
                            return d;
                        })
                        .attr("x", 0)
                        .attr("y", function (d, i) {
                            return i * gridSize;
                        })
                        .style("text-anchor", "end")
                        .attr("transform", "translate(-6," + gridSize / 1.5 + ")")
                        .attr("class", function (d, i) {
                            return ((i >= 0 && i <= 4) ? "nameLabels mono axis axis-workweek" : "nameLabels mono axis");
                        });

                var statelabels = svg.selectAll(".stateLabels")
                        .data(states)
                        .enter()
                        .append("text")
                        .text(function (d) {
                            return d;
                        })
                        .attr("y", 0)
                        .attr("x", function (d, i) {
                            return (i * gridSize) + 36;
                        })
                        .style("text-anchor", "middle")
                        .attr("transform", "translate(" + gridSize / 2 + ", -6)")
                        .attr("class", function (d, i) {
                            return ((i >= 7 && i <= 16) ? "stateLabels mono axis axis-worktime" : "stateLabels mono axis");
                        });

                // data manipulation
                var candidate_visit = [];
                data_f2.results.forEach(function (d) {
                        candidate_visit.push({"candidate": d.candidate.replace(" ", ""), "state": d.state});

                });
                console.log(candidate_visit);
                
                // Below code is for those candidates who were not visited the given three states.

                var arr=[];
                candidate_name.forEach(function(j,i){
                    var check =false;
                    candidate_visit.forEach(function(d,i){
                        if(d.candidate === j){
                            check=true;
                        }
                    });
                    
                    if(!check){
                        arr.push(j);
                         
                        candidate_visit.push({"candidate": j, "state": "none"});
                    }
                });
                //console.log(arr);

                var candidate_visit_count = d3.nest()
                        .key(function (d) {
                            return d.candidate;
                        })
                        .key(function (d) {
                            return d.state;
                        })
                        .rollup(function (v) {
                            var state = v[0].state;
                            var len = v.length;
                            if(state === "none"){
                                len = 0;
                            }
                        return {"candidate": v[0].candidate, "state": state, "count": len};
                    
                        })
                        .entries(candidate_visit);
                console.log(candidate_visit_count);
                
                candidate_visit_count.forEach(function(d){
                    
                });

                var cand_state_count = [];
                candidate_visit_count.forEach(function (d) {
                    var val = d.values;
                    //console.log(val);
                    val.forEach(function (d) {
                        cand_state_count.push(d.values);
                    });
                });
                console.log(cand_state_count);

                // data manipulation
                var colorScale = d3.scale.quantile()
                        .domain([0, buckets - 1, d3.max(cand_state_count, function (d) {
                                return d.count;
                            })])
                        .range(colors);

                var cards = svg.selectAll(".state").data(cand_state_count, function (d) {
                    return d.candidate + ":" + d.state;
                });

                cards.append("title");

                cards.enter().append("rect")
                        .attr("x", function (d) {
                            return ((states.indexOf(d.state) - 1) * gridSize) + 70;
                        })
                        .attr("y", function (d) {
                            return ((candidate_name.indexOf(d.candidate.replace(" ", "")) - 1) * gridSize) + 35;
                        })
                        .attr("rx", 4)
                        .attr("ry", 4)
                        .attr("class", "hour bordered")
                        .attr("width", gridSize)
                        .attr("height", gridSize)
                        .style("fill", colors[0]);

                cards.transition().duration(1000).style("fill", function (d) {
                    return colorScale(d.count);
                });

                cards.select("title").text(function (d) {
                    return d.count;
                });

                cards.exit().remove();

                var legend = svg.selectAll(".legend").data([0].concat(colorScale.quantiles()), function (d) {
                    return d;
                });

                legend.enter().append("g").attr("class", "legend");

                legend.append("rect")
                        .attr("x", w - 100)
                        .attr("y", function (d, i) {
                            return legendElementWidth * i
                        })
                        .attr("width", legendElementWidth - 20)
                        .attr("height", legendElementWidth)
                        .style("fill", function (d, i) {
                            return colors[i];
                        });

                legend.append("text")
                        .attr("class", "mono")
                        .text(function (d) {
                            return ">= " + Math.round(d);
                        })
                        .attr("x", w - 40)
                        .attr("y", function (d, i) {
                            return legendElementWidth * i
                        });

                legend.exit().remove();
            }

            // Reference from http://www.cis.umassd.edu/~dkoop/dsc530-2016sp/assignment3.html
            function processData(errors, f1data, f2data, f3data) {
                createMap("#Choropleth", f1data, f2data);
                createTopTenStopsMap("#Top10stops", f1data, f2data, f3data);
                candidateVisitsHeatmap("#Heatmap", f2data);
            }

            //References: https://github.com/d3/d3-queue
            var q = d3_queue.queue();
            q.defer(d3.json, "http://www.cis.umassd.edu/~dkoop/dsc530/a3/us-states.geojson")
            q.defer(d3.json, "http://www.cis.umassd.edu/~dkoop/dsc530/a3/trips.json")
            q.defer(d3.json, "http://www.cis.umassd.edu/~dkoop/dsc530/a3/city-similarities.json")
            q.await(processData);

        </script>
    </body>
</html>
